
compose:
  - call: lcod://tooling/registry_catalog.validate@0.1.0
    in:
      rootPath: $env.LCOD_REGISTRY_ROOT ?? '.'
      catalogPath: 'catalog.json'
    out:
      validation: $

  - call: lcod://tooling/script@1
    in:
      source: |
        async ({ state }) => {
          const errors = Array.isArray(state.errors) ? state.errors : [];
          if (errors.length > 0) {
            throw new Error(`Registry validation failed:\n${errors.join('\n')}`);
          }
          return { errors };
        }
      input:
        errors: $.validation.errors
    out:
      sanitizedErrors: errors

  - call: lcod://impl/set@1
    in:
      errors: $.sanitizedErrors
      packages: $.validation.packages
    out:
      errors: errors
      packages: packages
